##
## Configuration settings related to Velero installation namespace
##

# Labels settings in namespace
namespace:
  labels: {}

##
## End of namespace-related settings.
##

##
## Configuration settings that directly affect the Velero deployment YAML.
##

# Details of the container image to use in the Velero deployment & daemonset (if
# enabling node-agent). Required.
image:
  repository: velero/velero
  tag: v1.17.1
  pullPolicy: IfNotPresent

# Number of old history to retain to allow rollback (If not set, default Kubernetes value is set to 10)
revisionHistoryLimit: 1

# Resource requests/limits to specify for the Velero deployment.
# https://velero.io/docs/v1.6/customize-installation/#customize-resource-requests-and-limits
resources:
  requests:
    cpu: "100m"
    memory: "128Mi"
  limits:
    cpu: "500m"
    memory: "512Mi"

# Resource requests/limits to specify for the upgradeCRDs job pod. Need to be adjusted by user accordingly.
upgradeJobResources: {}
upgradeCRDsJob:
  automountServiceAccountToken: true

# Configure the dnsPolicy of the Velero deployment
# See: https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy
dnsPolicy: ClusterFirst

# Init containers to add to the Velero deployment's pod spec. At least one plugin provider image is required.
# If the value is a string then it is evaluated as a template.
initContainers:
  - name: velero-plugin-for-aws
    image: velero/velero-plugin-for-aws:v1.13.1
    imagePullPolicy: IfNotPresent
    volumeMounts:
      - mountPath: /target
        name: plugins

# Settings for Velero's prometheus metrics. Enabled by default.
metrics:
  enabled: false
  scrapeInterval: 30s
  scrapeTimeout: 10s

  # Pod annotations for Prometheus
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8085"
    prometheus.io/path: "/metrics"

  serviceMonitor:
    autodetect: true
    enabled: false
    annotations: {}
    additionalLabels: {}

    # metrics.serviceMonitor.metricRelabelings Specify Metric Relabelings to add to the scrape endpoint
    # ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#relabelconfig
    # metricRelabelings: []
    # metrics.serviceMonitor.relabelings [array] Prometheus relabeling rules
    # relabelings: []
    # ServiceMonitor namespace. Default to Velero namespace.
    # namespace:
    # ServiceMonitor connection scheme. Defaults to HTTP.
    # scheme: ""
    # ServiceMonitor connection tlsConfig. Defaults to {}.
    # tlsConfig: {}
  nodeAgentPodMonitor:
    autodetect: true
    enabled: false
    annotations: {}
    additionalLabels: {}
    # metrics.nodeAgentPodMonitor.metricRelabelings Specify Metric Relabelings to add to the scrape endpoint
    # ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#relabelconfig
    # metricRelabelings: []
    # metrics.nodeAgentPodMonitor.relabelings [array] Prometheus relabeling rules
    # relabelings: []
    # PodMonitor namespace. Default to Velero namespace.
    # namespace:
    # PodMonitor connection scheme. Defaults to HTTP.
    # scheme: ""
    # PodMonitor connection tlsConfig. Defaults to {}.
    # tlsConfig: {}

  prometheusRule:
    autodetect: true
    enabled: false
    # Additional labels to add to deployed PrometheusRule
    additionalLabels: {}
    # PrometheusRule namespace. Defaults to Velero namespace.
    # namespace: ""
    # Rules to be deployed
    spec: []
    # - alert: VeleroBackupFailed
    #   annotations:
    #     message: Velero backup {{ $labels.schedule }} has failed
    #   expr: |-
    #     velero_backup_last_status{schedule!=""} != 1
    #   for: 15m
    #   labels:
    #     severity: warning
    # - alert: VeleroBackupFailing
    #   annotations:
    #     message: Velero backup {{ $labels.schedule }} has been failing for the last 12h
    #   expr: |-
    #     velero_backup_last_status{schedule!=""} != 1
    #   for: 12h
    #   labels:
    #     severity: critical
    # - alert: VeleroNoNewBackup
    #   annotations:
    #     message: Velero backup {{ $labels.schedule }} has not run successfully in the last 25h
    #   expr: |-
    #     (
    #     (time() - velero_backup_last_successful_timestamp{schedule!=""}) >bool (25 * 3600)
    #     or
    #     absent(velero_backup_last_successful_timestamp{schedule!=""})
    #     ) == 1
    #   for: 1h
    #   labels:
    #     severity: critical
    # - alert: VeleroBackupPartialFailures
    #   annotations:
    #     message: Velero backup {{ $labels.schedule }} has {{ $value | humanizePercentage }} partialy failed backups
    #   expr: |-
    #     rate(velero_backup_partial_failure_total{schedule!=""}[25m])
    #       / rate(velero_backup_attempt_total{schedule!=""}[25m]) > 0.5
    #   for: 15m
    #   labels:
    #     severity: warning

# This job upgrades the CRDs.
upgradeCRDs: true

# This job is meant primarily for cleaning up CRDs on CI systems.
# Using this on production systems, especially those that have multiple releases of Velero, will be destructive.
cleanUpCRDs: false

##
## End of deployment-related settings.
##

##
## Parameters for the `default` BackupStorageLocation and VolumeSnapshotLocation,
## and additional server settings.
##
configuration:
  # Parameters for the BackupStorageLocation(s). Configure multiple by adding other element(s) to the backupStorageLocation slice.
  # See https://velero.io/docs/v1.6/api-types/backupstoragelocation/
  backupStorageLocation:
    # name is the name of the backup storage location where backups should be stored. If a name is not provided,
    # a backup storage location will be created with the name "default". Optional.
    - name: "default"
      # provider is the name for the backup storage location provider.
      provider: "aws"
      # bucket is the name of the bucket to store backups in. Required.
      bucket: "velero-backups"
      # default indicates this location is the default backup storage location. Optional.
      default: true
      # accessMode determines if velero can write to this backup storage location. Optional.
      # default to ReadWrite, ReadOnly is used during migrations and restores.
      accessMode: ReadWrite
      # Additional provider-specific configuration. See link above
      # for details of required/optional fields for your provider.
      config:
        region: "eu-central-1"
        s3ForcePathStyle: "true"
        s3Url: "https://192.168.10.100:9000"
        #  Option to skip certificate validation or not if insecureSkipTLSVerify is set to be true, the client side should set the
        #  flag. For Velero client Command like velero backup describe, velero backup logs needs to add the flag --insecure-skip-tls-verify
        insecureSkipTLSVerify: true

##
## End of backup/snapshot location settings.
##

##
## Settings for additional Velero resources.
##

rbac:
  # Whether to create the Velero role and role binding to give all permissions to the namespace to Velero.
  create: true
  # Whether to create the cluster role binding to give administrator permissions to Velero
  clusterAdministrator: true
  # Name of the ClusterRole.
  clusterAdministratorName: cluster-admin

# Information about the Kubernetes service account Velero uses.
serviceAccount:
  server:
    create: true
    # Configure if API credential for Service Account is automounted.
    automountServiceAccountToken: true

# Info about the secret to be used by the Velero deployment, which
# should contain credentials for the cloud provider IAM account you've
# set up for Velero.
credentials:
  # Whether a secret should be used. Set to false if, for examples:
  # - using kube2iam or kiam to provide AWS IAM credentials instead of providing the key file. (AWS only)
  # - using workload identity instead of providing the key file. (Azure/GCP only)
  useSecret: true
  # Name of a pre-existing secret (if any) in the Velero namespace
  # that should be used to get IAM account credentials. Optional.
  existingSecret: "velero-credentials"

# Whether to create backupstoragelocation crd, if false => do not create a default backup location
backupsEnabled: true
# Whether to create volumesnapshotlocation crd, if false => disable snapshot feature
snapshotsEnabled: false

# Whether to deploy the node-agent daemonset.
deployNodeAgent: false

schedules:
  daily-full-backup:
    disabled: false
    schedule: "0 0 * * *" # Daily at 00:00 UTC
    template:
      ttl: "168h" # 7 Days retain
      storageLocation: default
      includedNamespaces:
        - "*"
      excludedNamespaces:
        - kube-system
        - kube-public
        - kube-node-lease
        - longhorn-system
        - velero
        - metallb-system
